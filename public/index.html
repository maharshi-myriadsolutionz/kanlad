<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dark Kanban Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
      .scroll-container {
        width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        scroll-behavior: smooth;
      }
      .scroll-container::-webkit-scrollbar {
        width: 12px;
        height: 12px;
      }
      .scroll-container::-webkit-scrollbar-track {
        background: #1f1f1f;
        border-radius: 6px;
      }
      .scroll-container::-webkit-scrollbar-thumb {
        background-color: #888;
        border-radius: 6px;
        border: 3px solid #1f1f1f;
      }
      .scroll-container::-webkit-scrollbar-thumb:hover {
        background-color: #555;
      }
      .scroll-container {
        scrollbar-width: thin;
        scrollbar-color: #888 #1f1f1f;
      }
      .task {
        position: relative;
      }

      .task div > div {
        position: relative;
      }

      .task button {
        cursor: pointer;
      }

      .task .menu {
        position: absolute;
        right: 0;
        top: 100%;
        background-color: #1f1f1f;
        color: #fff;
        border-radius: 0.375rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        transition: opacity 0.2s;
        opacity: 0;
        pointer-events: none;
      }

      .task .menu.show {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="bg-zinc-950 text-gray-200 min-h-screen p-6 overflow-y-hidden">
    <div class="flex gap-6 items-start flex-col">
      <div class="flex gap-6">
        <h2 class="text-2xl font-bold">Kanban Board</h2>
        <!-- Add Column form (hidden initially) -->
        <div
          id="addColumnForm"
          class="hidden bg-zinc-900 rounded-lg p-3 w-72"
          style="height: 115px"
        >
          <input
            id="newColumnTitle"
            placeholder="Enter list name..."
            class="w-full rounded bg-zinc-800 text-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <div class="flex gap-2 mt-2">
            <button
              onclick="confirmAddColumn()"
              class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-2 text-sm"
            >
              Add list
            </button>
            <button
              onclick="cancelAddColumn()"
              class="text-gray-400 hover:text-white"
            >
              ✕
            </button>
          </div>
        </div>
        <div class="h-[115px] flex items-start">
          <button
            id="showAddColumnBtn"
            onclick="showAddColumnForm()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-2 text-sm"
          >
            + Add Column
          </button>
        </div>
      </div>
      <div class="flex flex-col items-center flex-1">
        <div class="scroll-container overflow-auto w-full">
          <div
            id="board"
            class="flex gap-6 min-h-[400px] pb-[40px] px-[10px] pt-0"
          ></div>
        </div>
      </div>
    </div>
    <script>
      let boardData = { columns: [], tasks: [] };

      async function loadBoard() {
        const res = await fetch("/board");
        boardData = await res.json();
        renderBoard();
      }

      function renderBoard() {
        const board = document.getElementById("board");
        board.innerHTML = "";
        boardData.columns.forEach((col) => {
          const columnEl = document.createElement("div");
          columnEl.className = "bg-zinc-900 rounded-xl flex flex-col p-5";
          columnEl.style.width = "340px";
          columnEl.innerHTML = `
            <div class="flex justify-between items-center mb-3 ">
              <h3 class="text-lg font-semibold">${col.title}</h3>
              <button onclick="deleteColumn(${col.id})" class="text-red-500 hover:text-red-400 text-sm">✕</button>
            </div>
            <ul id="col-${col.id}" class="column flex-1 min-h-[300px] space-y-3 p-1" data-col="${col.id}"></ul>
            <input id="newTask-${col.id}" placeholder="New task" 
                  class="mt-3 rounded bg-zinc-800 text-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="addTask(${col.id})" 
                    class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-2 text-sm">Add</button>
          `;
          board.appendChild(columnEl);

          const tasks = boardData.tasks
            .filter((t) => t.status === col.id)
            .sort((a, b) => a.position - b.position);
          tasks.forEach((task) => addTaskToColumn(task, col.id));

          const input = columnEl.querySelector(`#newTask-${col.id}`);
          input.addEventListener("keydown", async (e) => {
            if (e.key === "Enter") {
              e.preventDefault(); // prevent form submission or line break
              await addTask(col.id); // call your existing addTask function
            }
          });

          new Sortable(columnEl.querySelector(".column"), {
            group: "shared",
            animation: 200,
            handle: ".handle",
            ghostClass: "opacity-40",
            chosenClass: "bg-zinc-600",
            onEnd: async (evt) => {
              const items = [...evt.to.children];
              for (let i = 0; i < items.length; i++) {
                const id = parseInt(items[i].dataset.id);
                const status = parseInt(evt.to.dataset.col);

                // Update local boardData
                const task = boardData.tasks.find((t) => t.id === id);
                if (task) {
                  task.status = status;
                  task.position = i;
                }

                // Send update to server
                await fetch("/tasks/move", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id, status, position: i }),
                });
              }
            },
          });
        });
      }

      async function deleteColumn(colId) {
        if (
          !confirm(
            "Are you sure you want to delete this column? All tasks inside will also be deleted."
          )
        )
          return;

        await fetch(`/columns/${colId}/tasks`, { method: "DELETE" });
        await fetch(`/columns/${colId}`, { method: "DELETE" });

        boardData.columns = boardData.columns.filter((c) => c.id !== colId);
        boardData.tasks = boardData.tasks.filter((t) => t.status !== colId);
        renderBoard();
      }

      function addTaskToColumn(task, colId) {
        const li = document.createElement("li");
        li.className =
          "task flex flex-col bg-zinc-800 rounded px-3 py-2 text-sm shadow hover:bg-zinc-700 relative transition";

        li.dataset.id = task.id;

        // Task title
        const titleSpan = document.createElement("span");
        titleSpan.textContent = task.title;
        titleSpan.className = "editable font-medium cursor-pointer";
        titleSpan.onclick = () => startRenameTask(task.id, titleSpan);

        // Task description (if any)
        const descSpan = document.createElement("span");
        descSpan.textContent = task.description || "";
        descSpan.className = "description text-gray-400 text-xs mt-1";

        // Task bottom row (drag handle + options)
        const bottomRow = document.createElement("div");
        bottomRow.className = "flex justify-between items-center mt-2";

        // Drag handle
        const handle = document.createElement("span");
        handle.className = "handle cursor-grab text-gray-400";
        handle.textContent = "☰";

        // Options button
        const optionsBtn = document.createElement("button");
        optionsBtn.innerHTML = "⋮";
        optionsBtn.className =
          "text-gray-400 hover:text-white px-2 relative z-30";
        optionsBtn.onclick = (e) => {
          e.stopPropagation();
          menu.classList.toggle("opacity-0");
          menu.classList.toggle("pointer-events-none");
        };

        // Options menu
        const menu = document.createElement("div");
        menu.className =
          "absolute right-2 top-8 bg-zinc-900 text-gray-200 rounded shadow-lg flex flex-col opacity-0 pointer-events-none transition-opacity duration-200 z-20 menu";
        menu.innerHTML = `
    <button class="px-3 py-1 hover:bg-zinc-700 text-left text-sm">Edit</button>
    <button class="px-3 py-1 hover:bg-zinc-700 text-left text-sm">Delete</button>
    <button class="px-3 py-1 hover:bg-zinc-700 text-left text-sm">Add Description</button>
  `;

        // Menu button actions
        menu.children[0].onclick = () => startRenameTask(task.id, titleSpan);
        menu.children[1].onclick = () => deleteTask(task.id);
        menu.children[2].onclick = () => addDescription(task.id, descSpan);

        // Append everything
        bottomRow.appendChild(handle);
        bottomRow.appendChild(optionsBtn);
        li.appendChild(titleSpan);
        li.appendChild(descSpan);
        li.appendChild(bottomRow);
        li.appendChild(menu);

        document.getElementById(`col-${colId}`).appendChild(li);
      }

      async function addTask(colId) {
        const input = document.getElementById(`newTask-${colId}`);
        const title = input.value;
        if (!title) return;
        const res = await fetch("/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, status: colId }),
        });
        const task = await res.json();
        boardData.tasks.push(task);
        addTaskToColumn(task, colId);
        input.value = "";
      }

      function showAddColumnForm() {
        document.getElementById("addColumnForm").classList.remove("hidden");
        document.getElementById("showAddColumnBtn").classList.add("hidden");
        document.getElementById("newColumnTitle").focus();
      }

      async function confirmAddColumn() {
        const title = document.getElementById("newColumnTitle").value;
        if (!title) return;
        const res = await fetch("/columns", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title }),
        });
        const col = await res.json();
        boardData.columns.push(col);
        renderBoard();
        cancelAddColumn();
      }

      function cancelAddColumn() {
        document.getElementById("newColumnTitle").value = "";
        document.getElementById("addColumnForm").classList.add("hidden");
        document.getElementById("showAddColumnBtn").classList.remove("hidden");
      }

      function startRenameTask(id, spanEl) {
        const currentTitle = spanEl.textContent;
        const input = document.createElement("input");
        input.value = currentTitle;
        input.className =
          "w-full bg-zinc-700 text-gray-200 rounded px-2 py-1 text-sm focus:outline-none";
        spanEl.replaceWith(input);
        input.focus();

        input.addEventListener("blur", () => finishRenameTask(id, input));
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") finishRenameTask(id, input);
          if (e.key === "Escape") input.replaceWith(spanEl);
        });
      }

      async function finishRenameTask(id, inputEl) {
        const newTitle = inputEl.value.trim();
        if (!newTitle) return;
        await fetch("/tasks/rename", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, title: newTitle }),
        });
        const newSpan = document.createElement("span");
        newSpan.textContent = newTitle;
        newSpan.className = "editable flex-1 cursor-pointer";
        newSpan.onclick = () => startRenameTask(id, newSpan);
        inputEl.replaceWith(newSpan);
      }

      async function deleteTask(id) {
        if (!confirm("Are you sure you want to delete this task?")) return;
        await fetch(`/tasks/${id}`, { method: "DELETE" });
        boardData.tasks = boardData.tasks.filter((t) => t.id !== id);
        renderBoard();
      }

      async function addDescription(id, descSpan) {
        const current = descSpan.textContent || "";
        const desc = prompt("Enter task description:", current);
        if (desc === null) return;

        await fetch("/tasks/description", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, description: desc }),
        });

        // Update visible description
        descSpan.textContent = desc;

        // Update local board data
        const task = boardData.tasks.find((t) => t.id === id);
        if (task) task.description = desc;
      }

      loadBoard();
    </script>
  </body>
</html>
